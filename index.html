<!DOCTYPE html>
<html>
<head>
  <title>BIST Chat</title>
  <meta charset="UTF-8">
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; }
    #sidebar { width: 30%; background: #f0f0f0; padding: 10px; overflow-y: auto; position: relative; }
    #main { flex: 1; display: flex; flex-direction: column; }
    #chat-header { background: #ddd; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
    #chat-area { flex: 1; padding: 10px; overflow-y: auto; background: #fff; }
    #chat-input { display: flex; padding: 10px; background: #eee; }
    #chat-input input { flex: 1; padding: 5px; }
    #chat-input button { padding: 5px 10px; }
    #login { padding: 20px; }
    .chat-item { padding: 5px; cursor: pointer; border-bottom: 1px solid #ccc; }
    .chat-item.active { background: #ddd; }
    .message-own { text-align: right; }
    .message { margin-bottom: 5px; }
    #version { position: absolute; bottom: 10px; left: 10px; font-size: 12px; color: #888; }
  </style>
<script>
function safeEmail(email) {
  return email.replace(/[.#$[\]]/g, '_');
}

function addUserChat() {
  const email = prompt("Inserisci l'email dell'utente con cui vuoi chattare");
  if (!email || email === currentUser.email) {
    alert("Non puoi avviare una chat con te stesso.");
    return;
  }

  const chatId = [safeEmail(currentUser.email), safeEmail(email)].sort().join("_");

  get(ref(db, "users/" + currentUser.uid + "/chats/" + chatId)).then(snapshot => {
    if (snapshot.exists()) {
      alert("Hai giÃ  una chat con questo utente.");
      return;
    }

    set(ref(db, "users/" + currentUser.uid + "/chats/" + chatId), email).then(() => {
      get(query(ref(db, "profiles"), orderByChild("email"), equalTo(email))).then(snap => {
        if (snap.exists()) {
          const otherUid = Object.keys(snap.val())[0];
          set(ref(db, "users/" + otherUid + "/chats/" + chatId), currentUser.email).then(() => {
            loadChats();
          });
        } else {
          alert("Utente non trovato nel database.");
        }
      });
    });
  });
}
</script>
</head>
<body>
  <div id="login">
    <h2>Accedi a BIST Chat</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button id="login-btn">Login</button>
    <p id="output"></p>
  </div>
  <div id="app" style="display:none; width:100%;">
    <div id="sidebar">
      <h3>Chat</h3>
      <div id="chat-list"></div>
      <div id="version">beta-0.1.01</div>
    </div>
    <div id="main">
      <div id="chat-header">
        <span id="chat-name">BIST Chat</span>
        <div>
          <button id="add-btn">+ Aggiungi utente</button>
          <button id="name-btn">Modifica nome</button>
          <button id="logout-btn">Logout</button>
        </div>
      </div>
      <div id="chat-area"></div>
      <div id="chat-input">
        <input id="msg" placeholder="Scrivi un messaggio" maxlength="300">
        <button id="send-btn">Invia</button>
      </div>
    </div>
  </div>
</body>
</html>
