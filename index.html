<!DOCTYPE html>
<html>
<head>
  <title>BIST Chat</title>
  <meta charset="UTF-8">
	<link rel="icon" type="image/x-icon" href="bistchat-logo.ico">
  <style>
  body {
    background-color: black;
    color: #00ff00;
    font-family: 'Courier New', monospace;
    margin: 0;
    height: 100vh;
  }

  #app {
    display: flex;
    height: 100vh;
  }

  #sidebar {
    width: 30%;
    background: black;
    padding: 10px;
    overflow-y: auto;
    border-right: 2px solid #00ff00;
    position: relative;
  }

  #main {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  #chat-header {
    background: black;
    border-bottom: 2px solid #00ff00;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #chat-area {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
    background: black;
  }

  #chat-input {
    display: flex;
    padding: 10px;
    background: black;
    align-items: flex-end;
    gap: 10px;
    border-top: 2px solid #00ff00;
  }

  #chat-input textarea {
    flex: 1;
    width: 100%;
    min-height: 41px;
    max-height: 120px;
    resize: none;
    overflow-y: auto;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    background: black;
    color: #00ff00;
    font-family: 'Courier New', monospace;
    border: 2px solid #00ff00;
    padding: 5px;
    box-sizing: border-box;
  }

  #chat-input button {
    background-color: transparent;
    color: #00ff00;
    border: 2px solid #00ff00;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    font-size: 16px;
    padding: 10px 10px;
  }
  
  #chat-input button:hover {
    background-color: #006000;
    color: #ffffff;
    border: 2px solid #00ff00;
    cursor: pointer;
    font-family: 'Courier New', monospace;
    font-size: 16px;
    padding: 10px 10px;
  }

  #login {
  background: black;
  color: #00ff00;
  font-family: 'Courier New', monospace;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100vh;
  width: 100vw;
  position: fixed;
  top: 0;
  left: 0;
}

#login h2 {
  font-size: 28px;
  margin-bottom: 20px;
}

#login input {
  width: 300px;
  padding: 12px;
  margin: 10px 0;
  font-size: 16px;
  background-color: black;
  color: #00ff00;
  border: 2px solid #00ff00;
  font-family: 'Courier New', monospace;
}

#login button {
  width: 150px;
  padding: 10px;
  font-size: 16px;
  margin-top: 15px;
  cursor: pointer;
  background-color: transparent;
  color: #00ff00;
  border: 2px solid #00ff00;
  font-family: 'Courier New', monospace;
}

  .chat-item {
    padding: 5px;
    cursor: pointer;
    border-bottom: 1px solid #00ff00;
    color: #00ff00;
    user-select: none;
  }
  .chat-item:hover {
    padding: 5px;
    cursor: pointer;
    border-bottom: 1px solid #00ff00;
    color: #ffffff;
    background: #006000;
    user-select: none;
  }

  .chat-item.active {
    cursor: pointer;
    background: #00ff00;
    color: black;
  }

  .message-own {
    text-align: right;
  }

  .message {
    margin-bottom: 5px;
    white-space: pre-wrap;
  }
	  
  .chat-button {
  background-color: transparent;
  color: #00ff00;
  border: 2px solid #00ff00;
  cursor: pointer;
  font-family: 'Courier New', monospace;
  font-size: 16px;
  padding: 5x 10px;
  margin-left: 5px;
}

.chat-button:hover {
  background-color: #006000;
  border: 2px solid #00ff00;
  color: #ffffff;
}

  #version {
    position: absolute;
    bottom: 10px;
    left: 10px;
    font-size: 12px;
    color: #00ff00;
  }
  #chat-loader {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: black;
  color: #00ff00;
  display: none;
  align-items: center;
  justify-content: center;
  font-family: 'Courier New', monospace;
  font-size: 18px;
  z-index: 10;
}

#chat-input textarea:disabled {
  background-color: #222;
  color: #555;
  border-color: #555;
  cursor: not-allowed;
}

#chat-input button:disabled {
  color: #555;
  border-color: #555;
  cursor: not-allowed;
}
</style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, set, get, onChildAdded, off, orderByChild, query, equalTo, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKA15Li2IOnKKFrR7JAWw1SOPD31eIYZU",
      authDomain: "bist-chat.firebaseapp.com",
      databaseURL: "https://bist-chat-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bist-chat",
      storageBucket: "bist-chat.firebasestorage.app",
      messagingSenderId: "1009316312831",
      appId: "1:1009316312831:web:67996e1e45f7e6498afeca"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    let currentUser = null;
    let currentChat = "bist";
    let messageListeners = {};
    let displayNameMap = {};

    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("login-btn").onclick = login;
      document.getElementById("send-btn").onclick = sendMessage;
      document.getElementById("add-btn").onclick = addUserChat;
      document.getElementById("name-btn").onclick = changeDisplayName;
      document.getElementById("logout-btn").onclick = logout;
    });

    function safeEmail(str) {
      return str.replace(/[.#$\[\]]/g, '_');
    }

    function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      signInWithEmailAndPassword(auth, email, password)
        .then(userCred => {
          currentUser = userCred.user;
          get(ref(db, "profiles/" + currentUser.uid)).then(snap => {
            if (!snap.exists() || !snap.val()?.name) {
              let name = "";
              while (!name) {
                name = prompt("Insert your nickname (mandatory):");
              }
              set(ref(db, "profiles/" + currentUser.uid), {
                email: currentUser.email,
                name: name
              });
            }
          }).then(() => {
            document.getElementById("login").style.display = "none";
            document.getElementById("app").style.display = "flex";
            loadChats();
            switchChat("bist", document.querySelector(".chat-item"));
          });
        })
        .catch(err => {
          document.getElementById("output").innerText = err.message;
        });
    }

    function getDisplayName(uid, callback) {
      if (displayNameMap[uid]) {
        callback(displayNameMap[uid]);
      } else {
        get(ref(db, "profiles/" + uid)).then(snap => {
          const name = snap.val()?.name || "Unknow User";
          displayNameMap[uid] = name;
          callback(name);
        });
      }
    }
function sendMessage() {
  const textarea = document.getElementById("msg");
  const text = textarea.value.trim();
  if (!text) return;
  const timestamp = Date.now();
  set(ref(db, "chats/" + currentChat + "/" + timestamp), {
     uid: currentUser.uid,
     msg: text,
     time: timestamp
   });
   textarea.value = "";
   textarea.style.height = textarea.style.minHeight;
 }


    document.getElementById("msg").addEventListener("keydown", function (e) {
      if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
     }
     });
    document.getElementById("msg").addEventListener("input", function () {
      this.style.height = "auto"; // resetta
      this.style.height = Math.min(this.scrollHeight, 120) + "px"; // si espande fino a 120px
     });

function loadMessages(chatId) {
  const area = document.getElementById("chat-messages");
  area.innerHTML = "";

  // Rimuovi tutti i listener precedenti
  Object.keys(messageListeners).forEach(id => {
    off(ref(db, "chats/" + id), "child_added", messageListeners[id]);
    delete messageListeners[id];
  });

  const chatRef = ref(db, "chats/" + chatId);
  const callback = snap => {
    // Mostra solo i messaggi della chat attiva
    if (currentChat !== chatId) return;
    const data = snap.val();
    getDisplayName(data.uid, name => {
      const msgDiv = document.createElement("div");
      msgDiv.className = "message" + (data.uid === currentUser.uid ? " message-own" : "");
      const time = new Date(data.time).toLocaleString();
      msgDiv.textContent = `[${time}] ${name}: ${data.msg}`;
      area.appendChild(msgDiv);
      area.scrollTop = area.scrollHeight;
      hideChatLoading(); // Nasconde il loader appena arriva un messaggio
    });
  };

  messageListeners[chatId] = callback;
  onChildAdded(chatRef, callback);

  // Controlla se la chat √® vuota o non esiste e nasconde il loader
  get(chatRef).then(snap => {
    if (!snap.exists() || Object.keys(snap.val() || {}).length === 0) {
      hideChatLoading();  // Nasconde il loader se non ci sono messaggi
    }
  });
}

    function loadChats() {
      const list = document.getElementById("chat-list");
      list.innerHTML = "";
      const bist = document.createElement("div");
      bist.textContent = "BIST Chat";
      bist.className = "chat-item active";
      bist.onclick = () => switchChat("bist", bist);
      list.appendChild(bist);

      get(ref(db, "users/" + currentUser.uid + "/chats")).then(snap => {
        const chats = snap.val();
        if (chats) {
          Object.keys(chats).forEach(chatId => {
  const email = chats[chatId];
  get(query(ref(db, "profiles"), orderByChild("email"), equalTo(email))).then(snap => {
    const name = snap.exists()
      ? Object.values(snap.val())[0].name
      : email;

    const item = document.createElement("div");
    item.textContent = name;
    item.className = "chat-item";
    item.onclick = () => switchChat(chatId, item);
    list.appendChild(item);
  });
});
        }
      });
    }

function showChatLoading() {
  document.getElementById("chat-loader").style.display = "flex";
  document.getElementById("msg").disabled = true;
  document.getElementById("send-btn").disabled = true;
}

function hideChatLoading() {
  document.getElementById("chat-loader").style.display = "none";
  document.getElementById("msg").disabled = false;
  document.getElementById("send-btn").disabled = false;
}

    function switchChat(chatId, element) {
      showChatLoading();
      document.querySelectorAll(".chat-item").forEach(el => el.classList.remove("active"));
      if (element) element.classList.add("active");
      if (chatId === "bist") {
    document.getElementById("chat-name").innerText = "BIST Chat";
  } else {
    get(ref(db, "users/" + currentUser.uid + "/chats/" + chatId)).then(snap => {
      const email = snap.val();
      get(query(ref(db, "profiles"), orderByChild("email"), equalTo(email))).then(snap2 => {
        const name = snap2.exists()
          ? Object.values(snap2.val())[0].name
          : email;
        document.getElementById("chat-name").innerText = name;
      });
    });
  }
      currentChat = chatId;
      loadMessages(chatId);
    }

    function addUserChat() {
      const email = prompt("Insert the email of the user you want to chat with:");
      if (!email) return;
      if (email === currentUser.email) {
        alert("You can't create a chat with yourself!");
        return;
      }
      const safeCurrent = safeEmail(currentUser.email);
      const safeOther = safeEmail(email);
      const chatId = [safeCurrent, safeOther].sort().join("_");
      get(query(ref(db, "profiles"), orderByChild("email"), equalTo(email))).then(snap => {
        if (snap.exists()) {
          const otherUid = Object.keys(snap.val())[0];
          Promise.all([
            set(ref(db, "users/" + currentUser.uid + "/chats/" + chatId), email),
            set(ref(db, "users/" + otherUid + "/chats/" + chatId), currentUser.email),
            set(ref(db, "chats/" + chatId), {})
          ]).then(() => {
            loadChats();
            setTimeout(() => {
              const newChatElement = Array.from(document.querySelectorAll(".chat-item")).find(e => e.textContent === email);
              if (newChatElement) {
                switchChat(chatId, newChatElement);
              }
            }, 500);
          });
        } else {
          alert("User not found...");
        }
      });
    }

    function changeDisplayName() {
      const newName = prompt("Insert your new nickname:");
      if (!newName || !currentUser) return;
      set(ref(db, "profiles/" + currentUser.uid + "/name"), newName);
      displayNameMap[currentUser.uid] = newName;
    }

    function logout() {
      signOut(auth).then(() => {
      document.getElementById("app").style.display = "none";
      document.getElementById("login").style.display = "flex";
      document.getElementById("email").value = "";
      document.getElementById("password").value = "";
      currentUser = null;
      currentChat = "bist";
      Object.values(messageListeners).forEach(listener => off(listener));
      messageListeners = {};
      displayNameMap = {};
      document.getElementById("chat-messages").innerHTML = "";
    });
  }
  </script>
</head>
<body>
  <div id="login">
    <h2>Login into BIST Chat</h2>
    <input id="email" type="email" placeholder="Email"><br>
    <input id="password" type="password" placeholder="Password"><br>
    <button id="login-btn">Login</button>
    <p id="output"></p>
  </div>
  <div id="app" style="display:none; width:100%;">
    <div id="sidebar">
      <h3>Chats</h3>
      <div id="chat-list"></div>
      <div id="version">beta-0.2.01(fix-000)</div>
    </div>
    <div id="main">
      <div id="chat-header">
        <span id="chat-name">BIST Chat</span>
        <div>
	  <button id="add-btn" class="chat-button">‚ûï Add User</button>
          <button id="name-btn" class="chat-button">‚úèÔ∏è Edit Nickname</button>
          <button id="logout-btn" class="chat-button">üö™ Logout</button>
        </div>
      </div>
      <div id="chat-area" style="position: relative;">
  <div id="chat-messages"></div>
  <div id="chat-loader">
    <div class="loader-text">Loading BIST Chat...</div>
  </div>
</div>
      <div id="chat-input">
        <textarea id="msg" placeholder="Insert a message..." rows="1"></textarea>
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>
</body>
</html>
